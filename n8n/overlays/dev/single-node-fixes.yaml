# Single-node cluster fixes for n8n dev
apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n
  namespace: n8n
spec:
  template:
    spec:
      # Fix PostgreSQL hostname in init container
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until nc -z postgres-dev 5432; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is up - continuing"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
              - ALL
      
      containers:
      - name: n8n
        # Fix PostgreSQL hostname in environment
        env:
        - name: DB_POSTGRESDB_HOST
          value: "postgres-dev"
        - name: DB_POSTGRESDB_PORT
          value: "5432"
